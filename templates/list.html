<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обработки флота</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Стили для модального окна */
        .modal-side {
            position: fixed;
            top: 0;
            right: -350px; /* Изначально скрыто */
            height: 100%;
            width: 350px;
            margin: 0;
            transition: right 0.3s ease-in-out;
            z-index: 1050;
        }
        .modal-side.show {
            /* Позиция через JavaScript */
        }
        .modal-side .modal-content {
            height: 100%;
            border-radius: 0;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        .modal-side .modal-body {
            overflow-y: auto;
        }
        .modal-side + .modal-backdrop {
            background-color: transparent;
        }
        /* Стили для иконок в кнопках */
        .btn-sm i {
            font-size: 1rem;
        }
        /* Стили для формы фильтров */
        .filter-form {
            margin-bottom: 1.5rem;
        }
        .filter-form .form-group {
            margin-bottom: 1rem;
        }
        .filter-form select[multiple] {
            height: 100px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Управление обработками флота</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/create">Создать обработку</a>
                <a class="nav-link" href="/analytics">Аналитика</a>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h1>Список обработок</h1>
        
        <!-- Кнопки для сортировки и фильтров -->
        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary me-2" onclick="toggleSortOrder()">
                Сортировать по дате {% if sort_order == 'asc' %}(↑){% else %}(↓){% endif %}
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                Фильтры
            </button>
        </div>

        <!-- Форма фильтров в Collapse -->
        <div class="collapse" id="filterCollapse">
            <div class="card card-body filter-form">
                <form method="get" action="/">
                    <input type="hidden" name="sort_order" value="{{ sort_order }}">
                    <div class="row">
                        <div class="col-md-3 form-group">
                            <label for="ship_ids">Суда</label>
                            <select name="ship_ids" id="ship_ids" class="form-control" multiple>
                                {% for ship in ships %}
                                <option value="{{ ship.id }}" {% if ship.id|string in selected_ship_ids %}selected{% endif %}>{{ ship.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="start_date">Начальная дата</label>
                            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ selected_start_date or '' }}">
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="end_date">Конечная дата</label>
                            <input type="date" name="end_date" id="end_date" class="form-control" value="{{ selected_end_date or '' }}">
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="port_id">Порт</label>
                            <select name="port_id" id="port_id" class="form-control">
                                <option value="">Все порты</option>
                                {% for port in ports %}
                                <option value="{{ port.id }}" {% if port.id == selected_port_id %}selected{% endif %}>{{ port.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group mt-2">
                        <button type="submit" class="btn btn-primary">Применить</button>
                        <a href="/" class="btn btn-secondary">Сбросить</a>
                    </div>
                </form>
            </div>
        </div>

        <table class="table table-striped" id="operationsTable">
            <thead>
                <tr>
                    <th>Судно</th>
                    <th>Порт</th>
                    <th>Контрагент</th>
                    <th>Дата</th>
                    <th>Документы</th>
                    <th>Итоговая стоимость</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for operation in operations %}
                <tr style="cursor: pointer;" onclick="showDetails({{ operation.id | safe }})">
                    <td>{{ operation.ship.name }}</td>
                    <td>{{ operation.port.name }}</td>
                    <td>{{ operation.contractor.name }}</td>
                    <td>{{ operation.date }}</td>
                    <td>
                        {% if operation.has_documents %}
                        <i class="bi bi-check-circle text-success"></i>
                        {% else %}
                        <i class="bi bi-x-circle text-danger"></i>
                        {% endif %}
                    </td>
                    <td>{{ total_costs[operation.id] | float | round(2) }}</td>
                    <td>
                        <a href="/edit/{{ operation.id }}" class="btn btn-sm btn-primary" onclick="event.stopPropagation();"><i class="bi bi-pencil"></i></a>
                        <form action="/delete/{{ operation.id }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="event.stopPropagation(); return confirm('Вы уверены, что хотите удалить эту обработку?')"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Модальное окно вне контейнера -->
    <div class="modal fade modal-side" id="operationModal" tabindex="-1" aria-labelledby="operationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operationModalLabel">Подробности обработки</h5>
                </div>
                <div class="modal-body">
                    <p id="operationDetails"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentModal = null;

        function showDetails(operationId) {
            operationId = parseInt(operationId);
            const table = document.getElementById('operationsTable');
            const tableRect = table.getBoundingClientRect();
            const modal = document.getElementById('operationModal');
            const modalWidth = 350;
            const windowWidth = window.innerWidth;
            const tableRightEdge = tableRect.right;

            // Позиционируем модальное окно справа от таблицы
            const spaceForModal = windowWidth - tableRightEdge;
            if (spaceForModal < modalWidth) {
                modal.style.right = '0px';
            } else {
                modal.style.right = (windowWidth - tableRightEdge - modalWidth) + 'px';
            }

            fetch(`/operation/${operationId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка HTTP: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const detailsText = document.getElementById('operationDetails');
                    const modalTitle = document.getElementById('operationModalLabel');
                    modalTitle.textContent = `Обработка ${data.id}`;
                    let details = `
                        <strong>Судно:</strong> ${data.ship}<br>
                        <strong>Порт:</strong> ${data.port}<br>
                        <strong>Контрагент:</strong> ${data.contractor}<br>
                        <strong>Дата:</strong> ${data.date}<br>
                        <strong>Документы:</strong> ${data.has_documents ? 'Есть' : 'Нет'}<br>
                        <strong>Итоговая стоимость:</strong> ${data.total_cost.toFixed(2)}<br>
                        <strong>Загрязнители:</strong><br>
                    `;
                    data.pollutants.forEach(p => {
                        details += `${p.name}: Объём ${p.volume} куб.м, Стоимость ${p.cost}<br>`;
                    });
                    detailsText.innerHTML = details;
                    const modalInstance = new bootstrap.Modal(modal, { backdrop: true });
                    modalInstance.show();
                    currentModal = modalInstance;
                })
                .catch(error => console.error('Ошибка:', error));
        }

        // Закрытие модального окна по клику вне области
        document.addEventListener('click', function(event) {
            if (currentModal && !event.target.closest('.modal-content') && !event.target.closest('#operationsTable tr')) {
                currentModal.hide();
                currentModal = null;
            }
        });

        // Переключение сортировки
        function toggleSortOrder() {
            const currentOrder = '{{ sort_order }}';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            const params = new URLSearchParams(window.location.search);
            params.set('sort_order', newOrder);
            window.location.href = '/?' + params.toString();
        }
    </script>
</body>
</html>